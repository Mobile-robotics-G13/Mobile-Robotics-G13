#include <WiFi.h>

// ================= WIFI CONFIG =================
char ssid[]     = "Jamie's A34";
char password[] = "Retard101";

char server[]   = "3.250.38.184";
int port        = 8000;
String teamID   = "awsd7752";

WiFiClient client;
#define BUFSIZE 512

// ================= ROBOT STATES =================
enum RobotState {
  FOLLOW_LINE,
  AT_JUNCTION,
  TURNING
};

RobotState state = FOLLOW_LINE;

// ================= ROBOT DATA =================
int position = 0;          // Current node (0,1,2,3...)
int targetPosition = 1;    // Example target

bool junctionDetected = false;
bool turnComplete = false;

// ================= SETUP =================
void setup() {
  Serial.begin(9600);
  delay(1000);

  connectToWiFi();
  sendPosition(position);  // Initial position (0)
}

// ================= MAIN LOOP =================
void loop() {

  readSensors();
  actuateMotors();
  updateState();

  delay(50);  // Controller loop timing (from notes)
}

// ================= CORE LOGIC =================

void readSensors() {
  // ===== REPLACE WITH REAL SENSOR CODE =====
  // Example logic:
  // junctionDetected = (leftSensor && rightSensor && centerSensor);

  junctionDetected = false; // default

  // DEBUG SIMULATION (REMOVE LATER)
  static unsigned long lastTime = 0;
  if (millis() - lastTime > 5000 && position == 0) {
    junctionDetected = true;
    lastTime = millis();
  }
}

void actuateMotors() {

  switch (state) {

    case FOLLOW_LINE:
      Serial.println("Following line...");
      // followLine();
      break;

    case AT_JUNCTION:
      Serial.println("At junction, preparing to turn...");
      // stopMotors();
      break;

    case TURNING:
      Serial.println("Turning...");
      // turnTowardsTarget();
      turnComplete = true; // simulate turn complete
      break;
  }
}

void updateState() {

  switch (state) {

    case FOLLOW_LINE:
      if (junctionDetected) {
        state = AT_JUNCTION;
      }
      break;

    case AT_JUNCTION:
      state = TURNING;
      break;

    case TURNING:
      if (turnComplete) {
        position = targetPosition;
        sendPosition(position);

        turnComplete = false;
        junctionDetected = false;
        state = FOLLOW_LINE;
      }
      break;
  }
}

// ================= SERVER COMMUNICATION =================

void sendPosition(int pos) {

  if (!connectToServer()) {
    Serial.println("Server connection failed");
    return;
  }

  String body = "position=" + String(pos);

  client.print("POST /api/arrived/");
  client.print(teamID);
  client.println(" HTTP/1.1");
  client.println("Content-Type: application/x-www-form-urlencoded");
  client.print("Content-Length: ");
  client.println(body.length());
  client.println();
  client.println(body);

  String response = readResponse();
  Serial.println("Server reply:");
  Serial.println(response);

  client.stop();
}

// ================= WIFI HELPERS =================

void connectToWiFi() {
  Serial.print("Connecting to WiFi");
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(300);
  }

  Serial.println("\nWiFi connected");
  Serial.println(WiFi.localIP());
}

bool connectToServer() {
  return client.connect(server, port);
}

String readResponse() {
  unsigned long timeout = millis();
  while (!client.available()) {
    if (millis() - timeout > 5000) return "Timeout";
  }

  char buffer[BUFSIZE];
  memset(buffer, 0, BUFSIZE);
  client.readBytes(buffer, BUFSIZE);
  return String(buffer);
}
