#include <WiFi.h>

// ================= USER CONFIGURATION =================
char ssid[]      = "Jamie's A34";
char password[]  = "Retard101";

// Server Details
char server[]    = "3.250.38.184";
int port         = 8000;
String teamID    = "awsd7752";

// Objects
WiFiClient client;
#define BUFSIZE 512

// ================= SETUP =================
void setup() {
  Serial.begin(9600);
  delay(1000);

  connectToWiFi();
}

// ================= MAIN LOOP =================
void loop() {

  // --- SEND POSITION 0 ---
  sendPosition(0);

  Serial.println("Waiting 5 seconds...");
  delay(5000);

  // --- SEND NEXT POSITION ---
  sendPosition(1);

  Serial.println("Demo complete.");
  while (1);  // Stop program
}

// ================= FUNCTIONS =================

void sendPosition(int position) {

  if (!connectToServer()) {
    Serial.println("Server connection failed.");
    return;
  }

  String postBody = "position=" + String(position);

  Serial.print("Sending position ");
  Serial.println(position);

  client.print("POST /api/arrived/");
  client.print(teamID);
  client.println(" HTTP/1.1");

  client.println("Content-Type: application/x-www-form-urlencoded");
  client.print("Content-Length: ");
  client.println(postBody.length());
  client.println();

  client.println(postBody);

  String response = readResponse();

  int statusCode = getStatusCode(response);
  if (statusCode == 200) {
    String body = getResponseBody(response);
    Serial.print("Server response: ");
    Serial.println(body);
  } else {
    Serial.print("Server error: ");
    Serial.println(statusCode);
  }

  client.stop();
}

void connectToWiFi() {
  Serial.print("Connecting to ");
  Serial.println(ssid);

  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(300);
  }

  Serial.println("\nWiFi connected");
  Serial.println(WiFi.localIP());
}

bool connectToServer() {
  Serial.print("Connecting to server...");
  if (!client.connect(server, port)) {
    Serial.println("Failed");
    return false;
  }
  Serial.println("Connected");
  return true;
}

String readResponse() {
  unsigned long timeout = millis();
  while (client.available() == 0) {
    if (millis() - timeout > 5000) {
      return "Timeout";
    }
  }

  char buffer[BUFSIZE];
  memset(buffer, 0, BUFSIZE);
  client.readBytes(buffer, BUFSIZE);
  return String(buffer);
}

int getStatusCode(String& response) {
  if (response.length() < 12) return 0;
  return response.substring(9, 12).toInt();
}

String getResponseBody(String& response) {
  int split = response.indexOf("\r\n\r\n");
  if (split == -1) return "";
  String body = response.substring(split + 4);
  body.trim();
  return body;
}
