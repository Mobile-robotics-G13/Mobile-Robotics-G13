#include <WiFi.h>

// =======================================================
// ================= WIFI / SERVER CONFIG =================
// =======================================================
char ssid[]     = "Jamie's A34";
char password[] = "Retard101";

char server[]   = "3.250.38.184";
int port        = 8000;
String teamID   = "awsd7752";

WiFiClient client;
#define BUFSIZE 512

// =======================================================
// ================= ROUTING STATE ========================
// =======================================================
String currentNode = "0";
String targetNode  = "";

// =======================================================
// ================= SENSOR SETUP (UNCHANGED) =============
// =======================================================
int AnalogValue[5] = {0, 0, 0, 0, 0};
int AnalogPin[5]   = {4, 5, 6, 7, 15};

// ================= ULTRASONIC SENSOR SETUP =================
int trigPin = 48;
int echoPin = 45;
int stopDistance = 7;
int consecutiveDetections = 0;
int requiredDetections = 2;

// ================= MOTOR SETUP =================
int motorLeftPWM    = 37;
int motorLeftPhase  = 38;
int motorRightPWM   = 39;
int motorRightPhase = 20;

// ================= CALIBRATION =================
int threshold = 1500;  
int maxSpeed    = 220;  
int cruiseSpeed = 180;  
int turnSpeed   = 140;  

// =======================================================
// ================= SETUP ================================
// =======================================================
void setup() {
  Serial.begin(115200);

  pinMode(motorLeftPWM, OUTPUT);
  pinMode(motorLeftPhase, OUTPUT);
  pinMode(motorRightPWM, OUTPUT);
  pinMode(motorRightPhase, OUTPUT);

  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);

  stopMotors();

  connectToWiFi();

  // Required by brief
  sendArrival(currentNode);
}

// =======================================================
// ================= MAIN LOOP (UNCHANGED FLOW) ============
// =======================================================
void loop() {

  // ---------- ULTRASONIC OBSTACLE CODE (UNCHANGED) ----------
  long distance = getDistance();

  if (distance < stopDistance && distance > 0) {
    consecutiveDetections++;

    if (consecutiveDetections >= requiredDetections) {
      stopMotors();
      delay(300);

      spinRight(200);
      delay(200);

      bool onLine[5];
      int sensorsActive = 0;
      int turnAttempts = 0;

      while (sensorsActive < 1 && turnAttempts < 40) {
        spinRight(200);
        delay(50);

        sensorsActive = 0;
        for (int i = 0; i < 5; i++) {
          AnalogValue[i] = analogRead(AnalogPin[i]);
          if (AnalogValue[i] < threshold) sensorsActive++;
        }
        turnAttempts++;
      }

      stopMotors();
      delay(300);
      moveForward(200, 200);
      delay(50);

      consecutiveDetections = 0;
      return;
    }
  }

  // ---------- LINE FOLLOWING (UNCHANGED) ----------
  bool onLine[5];
  int sensorsActive = 0;

  for (int i = 0; i < 5; i++) {
    AnalogValue[i] = analogRead(AnalogPin[i]);
    onLine[i] = (AnalogValue[i] < threshold);
    if (onLine[i]) sensorsActive++;
  }

  if (sensorsActive >= 3) {
    handleIntersection();   // <<< ROUTING HOOK
  }
  else if (onLine[2] && !onLine[0] && !onLine[4]) {
    moveForward(maxSpeed, maxSpeed); 
  }
  else if (onLine[1]) {
    moveForward(150, cruiseSpeed); 
  }
  else if (onLine[3]) {
    moveForward(cruiseSpeed, 150);
  }
  else if (onLine[0]) {
    spinLeft(turnSpeed);
  }
  else if (onLine[4]) {
    spinRight(turnSpeed);
  }
  else {
    moveForward(250, 250); 
  }
}

// =======================================================
// ================= INTERSECTION HANDLER =================
// =======================================================
void handleIntersection() {

  stopMotors();
  Serial.print("Arrived at node ");
  Serial.println(currentNode);

  // ---- SERVER COMMUNICATION ----
  sendArrival(currentNode);
  targetNode = getNextNode();

  // ---- LOCAL ROUTING DECISION ----
  decideTurn(currentNode, targetNode);

  currentNode = targetNode;

  delay(1000);

  unsigned long clearTime = millis();
  while (millis() - clearTime < 250) {
    moveForward(200, 200);
  }
}

// =======================================================
// ================= ROUTE DECISION (MAP LOGIC) ============
// =======================================================
void decideTurn(String from, String to) {

  Serial.print("Routing ");
  Serial.print(from);
  Serial.print(" -> ");
  Serial.println(to);

  // NODE 0
  if (from == "0" && to == "1") {
    moveForward(200, 200); delay(300);
  }
  else if (from == "0" && to == "4") {
    spinLeft(200); delay(400);
  }

  // NODE 1
  else if (from == "1" && to == "2") {
    spinRight(200); delay(400);
  }
  else if (from == "1" && to == "0") {
    moveForward(200, 200); delay(300);
  }

  // NODE 2
  else if (from == "2" && to == "3") {
    moveForward(200, 200); delay(300);
  }
  else if (from == "2" && to == "1") {
    spinLeft(200); delay(400);
  }

  // NODE 3
  else if (from == "3" && to == "5") {
    spinLeft(200); delay(400);
  }
  else if (from == "3" && to == "2") {
    moveForward(200, 200); delay(300);
  }

  // NODE 4
  else if (from == "4" && to == "5") {
    spinRight(200); delay(400);
  }
  else if (from == "4" && to == "0") {
    moveForward(200, 200); delay(300);
  }

  // NODE 5
  else if (from == "5" && to == "3") {
    spinRight(200); delay(400);
  }
  else if (from == "5" && to == "4") {
    spinLeft(200); delay(400);
  }

  else {
    Serial.println("ERROR: Unknown route");
  }
}

// =======================================================
// ================= SERVER COMMUNICATION =================
// =======================================================
void sendArrival(String node) {

  if (!client.connect(server, port)) return;

  String body = "position=" + node;

  client.print("POST /api/arrived/");
  client.print(teamID);
  client.println(" HTTP/1.1");
  client.println("Content-Type: application/x-www-form-urlencoded");
  client.print("Content-Length: ");
  client.println(body.length());
  client.println();
  client.println(body);

  readResponse();
  client.stop();
}

String getNextNode() {

  if (!client.connect(server, port)) return "";

  client.print("GET /api/next/");
  client.print(teamID);
  client.println(" HTTP/1.1");
  client.println("Connection: close");
  client.println();

  String response = readResponse();
  client.stop();

  int split = response.indexOf("\r\n\r\n");
  if (split == -1) return "";

  String body = response.substring(split + 4);
  body.trim();

  Serial.print("Next node: ");
  Serial.println(body);

  return body;
}

// =======================================================
// ================= WIFI HELPERS =========================
// =======================================================
void connectToWiFi() {
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) delay(300);
  Serial.println("WiFi Connected");
}

String readResponse() {
  unsigned long timeout = millis();
  while (!client.available()) {
    if (millis() - timeout > 5000) return "";
  }
  char buffer[BUFSIZE];
  memset(buffer, 0, BUFSIZE);
  client.readBytes(buffer, BUFSIZE);
  return String(buffer);
}

// =======================================================
// ================= HELPER FUNCTIONS (UNCHANGED) =========
// =======================================================
long getDistance() {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);
  long duration = pulseIn(echoPin, HIGH, 30000);
  if (duration == 0) return 999;
  long distance = (duration / 2) * 0.0343;
  if (distance < 2 || distance > 400) return 999;
  return distance;
}

void moveForward(int left, int right) {
  digitalWrite(motorLeftPhase, HIGH);
  digitalWrite(motorRightPhase, HIGH);
  analogWrite(motorLeftPWM, left);
  analogWrite(motorRightPWM, right);
}

void spinLeft(int speed) {
  digitalWrite(motorLeftPhase, LOW);
  digitalWrite(motorRightPhase, HIGH);
  analogWrite(motorLeftPWM, speed);
  analogWrite(motorRightPWM, speed);
}

void spinRight(int speed) {
  digitalWrite(motorLeftPhase, HIGH);
  digitalWrite(motorRightPhase, LOW);
  analogWrite(motorLeftPWM, speed);
  analogWrite(motorRightPWM, speed);
}

void stopMotors() {
  analogWrite(motorLeftPWM, 0);
  analogWrite(motorRightPWM, 0);
}
